<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחשבון מחירי דיור בקיבוץ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rubik', sans-serif;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 55vh;
            width: 95%;
        }
        .tab-btn.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* blue-50 */
        }
        .radio-label {
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        input[type="radio"]:checked + .radio-label {
            background-color: #bfdbfe;
            border-color: #3b82f6;
            color: #1e3a8a;
        }
        .summary-value {
            font-size: 2.25rem; /* Adjusted for mobile */
            font-weight: 700;
            line-height: 1.2;
            color: #1e3a8a; /* blue-900 */
        }
        .summary-value-bad {
            color: #be123c; /* rose-700 */
        }
        .discount-badge {
            background-color: #10b981; /* green-500 */
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 500;
            display: inline-block;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="md:hidden fixed top-4 left-4 z-50 bg-white p-2 rounded-full shadow-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="hidden fixed inset-0 bg-gray-800 bg-opacity-90 z-40 flex items-center justify-center">
        <nav class="flex flex-col items-center space-y-8">
            <button class="mobile-nav-link text-white text-3xl font-bold" data-tab="calculator">מחשבון אישי</button>
            <button class="mobile-nav-link text-white text-3xl font-bold" data-tab="timeline-comparison">השוואה לאורך זמן</button>
            <button class="mobile-nav-link text-white text-3xl font-bold" data-tab="increase-analysis">ניתוח עליית מחירים</button>
            <button class="mobile-nav-link text-white text-3xl font-bold" data-tab="data-tables">טבלאות נתונים</button>
        </nav>
    </div>


    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-5xl font-bold text-blue-800">תמורות בדמי הרשאה נצר-סרני 2025</h1>
        </header>

        <!-- Desktop Tab Navigation -->
        <div class="mb-8 hidden md:block">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex justify-center space-x-1 md:space-x-4" aria-label="Tabs">
                    <button class="tab-btn whitespace-nowrap py-4 px-2 md:px-4 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200 active" data-tab="calculator">מחשבון אישי</button>
                    <button class="tab-btn whitespace-nowrap py-4 px-2 md:px-4 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200" data-tab="timeline-comparison">השוואה לאורך זמן</button>
                    <button class="tab-btn whitespace-nowrap py-4 px-2 md:px-4 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200" data-tab="increase-analysis">ניתוח עליית מחירים</button>
                    <button class="tab-btn whitespace-nowrap py-4 px-2 md:px-4 border-b-2 font-medium text-lg border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors duration-200" data-tab="data-tables">טבלאות נתונים</button>
                </nav>
            </div>
        </div>

        <main>
            <!-- Personal Calculator Tab -->
            <div id="calculator" class="tab-content bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl md:text-3xl font-semibold text-center mb-8 text-blue-700">מחשבון שכירות אישי</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 items-end">
                    <div>
                        <label for="ageInput" class="block mb-2 text-sm font-medium text-gray-900">גיל:</label>
                        <input type="number" id="ageInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="areaSelectCalc" class="block mb-2 text-sm font-medium text-gray-900">אזור מגורים:</label>
                        <select id="areaSelectCalc" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                           <option selected disabled>בחירה...</option>
                        </select>
                    </div>
                    <div>
                        <label for="houseTypeSelectCalc" class="block mb-2 text-sm font-medium text-gray-900">סוג בית:</label>
                        <select id="houseTypeSelectCalc" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" disabled>
                            <option selected disabled>יש לבחור קודם אזור...</option>
                        </select>
                    </div>
                    <div>
                        <label for="sqmInputCalc" class="block mb-2 text-sm font-medium text-gray-900">שטח לחישוב ארנונה (מ"ר):</label>
                        <input type="number" id="sqmInputCalc" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" disabled>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button id="calculateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 disabled:bg-gray-400 text-lg" disabled>חישוב</button>
                </div>
                <div id="personalResult" class="mt-8 hidden text-center">
                    <div id="summary" class="mb-8"></div>
                    <div id="interactive-visualization" class="w-full max-w-md mx-auto h-32 bg-gray-100 rounded-lg p-4 flex items-center">
                        <div class="w-full">
                            <div class="h-8 bg-blue-200 rounded-full flex items-center relative transition-all duration-1000" id="price-bar-container">
                                <div class="h-8 bg-blue-500 rounded-full transition-all duration-1000" id="old-price-bar" style="width: 0%;"></div>
                                <div class="absolute text-white font-bold right-2 text-sm" id="old-price-label"></div>
                            </div>
                            <div class="text-xs text-gray-500 text-right mt-1">מחיר 2025 בהסדר קיים</div>
                            <div class="h-8 bg-red-200 rounded-full flex items-center relative transition-all duration-1000 mt-2" id="new-price-bar-container">
                                 <div class="h-8 bg-red-500 rounded-full transition-all duration-1000" id="new-price-bar" style="width: 0%;"></div>
                                 <div class="absolute text-white font-bold right-2 text-sm" id="new-price-label"></div>
                            </div>
                            <div class="text-xs text-gray-500 text-right mt-1">מחיר 2025 לאחר שינוי ההסדר (כולל ארנונה)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline Comparison Tab -->
            <div id="timeline-comparison" class="tab-content hidden bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl md:text-3xl font-semibold text-center mb-6 text-blue-700">השוואה לאורך זמן</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="areaSelectTimeline" class="block mb-2 text-sm font-medium text-gray-900">אזור מגורים:</label>
                        <select id="areaSelectTimeline" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                    </div>
                    <div>
                        <label for="houseTypeSelectTimeline" class="block mb-2 text-sm font-medium text-gray-900">סוג בית:</label>
                        <select id="houseTypeSelectTimeline" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" disabled></select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <!-- Price Increase Analysis Tab -->
            <div id="increase-analysis" class="tab-content hidden bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl md:text-3xl font-semibold text-center mb-6 text-blue-700">ניתוח אחוז עליית המחירים</h2>
                <div class="space-y-4">
                    <div class="flex justify-center flex-wrap gap-4">
                        <h3 class="w-full text-center text-lg font-medium text-gray-700">קבוצת גיל להצגה:</h3>
                        <input type="radio" name="age_group_option" id="age_opt_30" value="30_MINUS" class="hidden">
                        <label for="age_opt_30" class="radio-label">30 ומטה</label>
                        <input type="radio" name="age_group_option" id="age_opt_37" value="31-37" class="hidden">
                        <label for="age_opt_37" class="radio-label">31-37</label>
                        <input type="radio" name="age_group_option" id="age_opt_38" value="38_PLUS" class="hidden" checked>
                        <label for="age_opt_38" class="radio-label">38 ומעלה</label>
                    </div>
                    <div class="flex justify-center flex-wrap gap-4 pt-4 border-t">
                         <h3 class="w-full text-center text-lg font-medium text-gray-700">יש לבחור סוג השוואה:</h3>
                        <input type="radio" name="increase_option" id="opt1" value="2022_2025_orig" class="hidden">
                        <label for="opt1" class="radio-label">2022-2025 (לפי הסדר קיים)</label>
                        <input type="radio" name="increase_option" id="opt2" value="2024_2025_orig" class="hidden">
                        <label for="opt2" class="radio-label">2024-2025 (לפי הסדר קיים)</label>
                        <input type="radio" name="increase_option" id="opt3" value="2024_2025_new" class="hidden" checked>
                        <label for="opt3" class="radio-label">2024-2025 (לפי ההסדר המוצע)</label>
                    </div>
                </div>
                <div class="chart-container mt-6 h-[80vh] md:h-[55vh]">
                    <canvas id="priceIncreaseChart"></canvas>
                </div>
            </div>
            
            <!-- Data Tables Tab -->
            <div id="data-tables" class="tab-content hidden bg-white p-4 md:p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl md:text-3xl font-semibold text-center mb-6 text-blue-700">טבלאות נתוני הדיור</h2>
                 <div class="text-center mb-4">
                    <a href="https://docs.google.com/spreadsheets/d/1LWmOBxmxPEYQj5lGNCRx8I4CDRPOvr80fLCrM8ZnMGg/edit?usp=sharing" target="_blank" class="text-blue-600 hover:underline font-semibold">לצפיה בגוגל שיטס</a>
                </div>
                <div class="w-full h-[70vh] border rounded-lg overflow-auto bg-gray-200">
                    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vSi61V2wvUaObN0L3_dsQWfxgO5oIoFLYvrDXzixK58SJzqvWhCj3r4W7ngH_X-_Qp5iSOZL-h87j9k/pubhtml?widget=true&amp;headers=false" class="w-full h-full min-w-[800px]"></iframe>
                </div>
            </div>
        </main>
    </div>

    <script>
        const housingData = {
            '30_MINUS': [
                { area: 'בקעה', type: 'חדר יחיד ברכבות', sqm: 21, price2022: 850, price2023: 900, price2024: 1000, price2025_old: 1000, price2025_new: 1050 },
                { area: 'בקעה', type: 'חדר אמצע', sqm: 17, price2022: 850, price2023: 900, price2024: 1000, price2025_old: 1000, price2025_new: 1050 },
                { area: 'בקעה', type: 'בית חיילים', sqm: 27, price2022: 850, price2023: 900, price2024: 1000, price2025_old: 1000, price2025_new: 1050 },
                { area: 'בקעה', type: 'רכבות חדר כפול', sqm: 38, price2022: 1500, price2023: 1700, price2024: 2000, price2025_old: 2000, price2025_new: 2200 },
                { area: 'בקעה', type: 'דירת צד', sqm: 43, price2022: 1600, price2023: 1900, price2024: 2200, price2025_old: 2200, price2025_new: 2400 },
                { area: 'בקעה', type: 'דירת צד מורחבת', sqm: 57, price2022: 1800, price2023: 2200, price2024: 2600, price2025_old: 2600, price2025_new: 2700 },
                { area: 'סדנה/נוער', type: 'דירת סדנה', sqm: 60.5, price2022: 1750, price2023: 2400, price2024: 3100, price2025_old: 3800, price2025_new: 4600 },
                { area: 'סדנה/נוער', type: 'דירת 3 חדרים', sqm: 80, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 4900 },
                { area: 'סדנה/נוער', type: 'דירת נוער (מורחבת 4.5 חדרים)', sqm: 71, price2022: 1850, price2023: 2400, price2024: 3000, price2025_old: 3700, price2025_new: 4900 },
                { area: 'קרווילות', type: 'קרווילה קטנה', sqm: 88, price2022: 1850, price2023: 2400, price2024: 3000, price2025_old: 3700, price2025_new: 4600 },
                { area: 'קרווילות', type: 'קרווילה גדולה', sqm: 65.5, price2022: 1400, price2023: 2300, price2024: 3300, price2025_old: 4300, price2025_new: 5900 },
                { area: 'קרווילות', type: 'קרווילה קטנה מורחבת', sqm: 80, price2022: 2400, price2023: 3100, price2024: 3800, price2025_old: 4600, price2025_new: 5900 },
                { area: 'קרווילות', type: 'קרווילה גדולה מורחבת', sqm: 107, price2022: 2750, price2023: 3400, price2024: 4200, price2025_old: 5000, price2025_new: 6800 },
                { area: 'מחנה', type: 'דירת 2 חדרים', sqm: 45, price2022: 1450, price2023: 1800, price2024: 2200, price2025_old: 2700, price2025_new: 3100 },
                { area: 'מחנה', type: 'דירת 2 חדרים קטנה', sqm: 42, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 2800 },
                { area: 'מחנה', type: 'דירת 2.5 חדרים', sqm: 64, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 4900 },
                { area: 'מחנה', type: 'דירת 3 חדרים', sqm: 83, price2022: 1850, price2023: 2600, price2024: 3400, price2025_old: 4200, price2025_new: 5400 },
                { area: 'מחנה', type: 'דירת 4 חדרים', sqm: 89, price2022: 2100, price2023: 2800, price2024: 3600, price2025_old: 4400, price2025_new: 5700 },
                { area: 'מחנה', type: 'דירת 4 חדרים מורחבת', sqm: 112, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 6200 },
                { area: 'מחנה', type: 'דירת 5 חדרים', sqm: 126, price2022: 2450, price2023: 3200, price2024: 4000, price2025_old: 4800, price2025_new: 6800 },
                { area: 'מחנה', type: 'דירת 6 חדרים', sqm: null, price2022: 2550, price2023: 3500, price2024: 4500, price2025_old: 5500, price2025_new: null },
                { area: 'מחנה', type: 'שכונות חדשות', sqm: 128, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 10800 },
            ],
            '31-37': [
                { area: 'בקעה', type: 'חדר יחיד ברכבות', sqm: 21, price2022: 1350, price2023: 1400, price2024: 1600, price2025_old: 1600, price2025_new: 1700 },
                { area: 'בקעה', type: 'חדר אמצע', sqm: 17, price2022: 1350, price2023: 1400, price2024: 1600, price2025_old: 1600, price2025_new: 1700 },
                { area: 'בקעה', type: 'בית חיילים', sqm: 27, price2022: 1350, price2023: 1400, price2024: 1600, price2025_old: 1600, price2025_new: 1700 },
                { area: 'בקעה', type: 'רכבות חדר כפול', sqm: 38, price2022: 2050, price2023: 2200, price2024: 2400, price2025_old: 2400, price2025_new: 2600 },
                { area: 'בקעה', type: 'דירת צד', sqm: 43, price2022: 2200, price2023: 2400, price2024: 2600, price2025_old: 2600, price2025_new: 2800 },
                { area: 'בקעה', type: 'דירת צד מורחבת', sqm: 57, price2022: 2400, price2023: 2800, price2024: 3300, price2025_old: 3300, price2025_new: 3400 },
                { area: 'סדנה/נוער', type: 'דירת סדנה', sqm: 60.5, price2022: 2600, price2023: 2900, price2024: 3400, price2025_old: 3800, price2025_new: 4600 },
                { area: 'סדנה/נוער', type: 'דירת 3 חדרים', sqm: 80, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 4900 },
                { area: 'סדנה/נוער', type: 'דירת נוער (מורחבת 4.5 חדרים)', sqm: 71, price2022: 2800, price2023: 3000, price2024: 3400, price2025_old: 3700, price2025_new: 5600 },
                { area: 'קרווילות', type: 'קרווילה קטנה', sqm: 88, price2022: 2800, price2023: 3000, price2024: 3400, price2025_old: 3700, price2025_new: 4900 },
                { area: 'קרווילות', type: 'קרווילה גדולה', sqm: 65.5, price2022: 2950, price2023: 3300, price2024: 3800, price2025_old: 4300, price2025_new: 5900 },
                { area: 'קרווילות', type: 'קרווילה קטנה מורחבת', sqm: 80, price2022: 3300, price2023: 3700, price2024: 4100, price2025_old: 4600, price2025_new: 5900 },
                { area: 'קרווילות', type: 'קרווילה גדולה מורחבת', sqm: 107, price2022: 3700, price2023: 4100, price2024: 4500, price2025_old: 5000, price2025_new: 6800 },
                { area: 'מחנה', type: 'דירת 2 חדרים', sqm: 45, price2022: 2200, price2023: 2300, price2024: 2500, price2025_old: 2700, price2025_new: 3100 },
                { area: 'מחנה', type: 'דירת 2 חדרים קטנה', sqm: 42, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 2800 },
                { area: 'מחנה', type: 'דירת 2.5 חדרים', sqm: 64, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 4900 },
                { area: 'מחנה', type: 'דירת 3 חדרים', sqm: 83, price2022: 2800, price2023: 3200, price2024: 3700, price2025_old: 4200, price2025_new: 5400 },
                { area: 'מחנה', type: 'דירת 4 חדרים', sqm: 89, price2022: 2950, price2023: 3400, price2024: 3900, price2025_old: 4400, price2025_new: 5700 },
                { area: 'מחנה', type: 'דירת 4 חדרים מורחבת', sqm: 112, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 6200 },
                { area: 'מחנה', type: 'דירת 5 חדרים', sqm: 126, price2022: 3700, price2023: 4000, price2024: 4400, price2025_old: 4800, price2025_new: 6800 },
                { area: 'מחנה', type: 'דירת 6 חדרים', sqm: null, price2022: 3600, price2023: 4200, price2024: 4800, price2025_old: 5500, price2025_new: null },
                { area: 'מחנה', type: 'שכונות חדשות', sqm: 128, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 10800 },
            ],
            '38_PLUS': [
                { area: 'בקעה', type: 'חדר יחיד ברכבות', sqm: 21, price2022: 1700, price2023: 1800, price2024: 2100, price2025_old: 2100, price2025_new: 2200 },
                { area: 'בקעה', type: 'חדר אמצע', sqm: 17, price2022: 1700, price2023: 1800, price2024: 2100, price2025_old: 2100, price2025_new: 2200 },
                { area: 'בקעה', type: 'בית חיילים', sqm: 27, price2022: 2000, price2023: 2000, price2024: 2100, price2025_old: 2100, price2025_new: 2200 },
                { area: 'בקעה', type: 'רכבות חדר כפול', sqm: 38, price2022: 3300, price2023: 3300, price2024: 3500, price2025_old: 3500, price2025_new: 3800 },
                { area: 'בקעה', type: 'דירת צד', sqm: 43, price2022: 3600, price2023: 3600, price2024: 3800, price2025_old: 3800, price2025_new: 4100 },
                { area: 'בקעה', type: 'דירת צד מורחבת', sqm: 57, price2022: 4300, price2023: 4300, price2024: 4500, price2025_old: 4500, price2025_new: 4600 },
                { area: 'סדנה/נוער', type: 'דירת סדנה', sqm: 60.5, price2022: 4800, price2023: 4800, price2024: 4800, price2025_old: 4800, price2025_new: 5600 },
                { area: 'סדנה/נוער', type: 'דירת 3 חדרים', sqm: 80, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 5900 },
                { area: 'סדנה/נוער', type: 'דירת נוער (מורחבת 4.5 חדרים)', sqm: 71, price2022: 4700, price2023: 4700, price2024: 4700, price2025_old: 4700, price2025_new: 6600 },
                { area: 'קרווילות', type: 'קרווילה קטנה', sqm: 88, price2022: 4700, price2023: 4700, price2024: 4700, price2025_old: 4700, price2025_new: 5900 },
                { area: 'קרווילות', type: 'קרווילה גדולה', sqm: 65.5, price2022: 5300, price2023: 5300, price2024: 5300, price2025_old: 5300, price2025_new: 6900 },
                { area: 'קרווילות', type: 'קרווילה קטנה מורחבת', sqm: 80, price2022: 5600, price2023: 5600, price2024: 5600, price2025_old: 5600, price2025_new: 6900 },
                { area: 'קרווילות', type: 'קרווילה גדולה מורחבת', sqm: 107, price2022: 6000, price2023: 6000, price2024: 6000, price2025_old: 6000, price2025_new: 7800 },
                { area: 'מחנה', type: 'דירת 2 חדרים', sqm: 45, price2022: 3500, price2023: 3500, price2024: 3500, price2025_old: 3500, price2025_new: 4100 },
                { area: 'מחנה', type: 'דירת 2 חדרים קטנה', sqm: 42, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 3800 },
                { area: 'מחנה', type: 'דירת 2.5 חדרים', sqm: 64, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 5900 },
                { area: 'מחנה', type: 'דירת 3 חדרים', sqm: 83, price2022: 5200, price2023: 5200, price2024: 5200, price2025_old: 5200, price2025_new: 6600 },
                { area: 'מחנה', type: 'דירת 4 חדרים', sqm: 89, price2022: 5400, price2023: 5400, price2024: 5400, price2025_old: 5400, price2025_new: 6700 },
                { area: 'מחנה', type: 'דירת 4 חדרים מורחבת', sqm: 112, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 7200 },
                { area: 'מחנה', type: 'דירת 5 חדרים', sqm: 126, price2022: 5800, price2023: 5800, price2024: 5800, price2025_old: 5800, price2025_new: 7800 },
                { area: 'מחנה', type: 'דירת 6 חדרים', sqm: null, price2022: 6500, price2023: 6500, price2024: 6500, price2025_old: 6500, price2025_new: null },
                { area: 'מחנה', type: 'שכונות חדשות', sqm: 128, price2022: null, price2023: null, price2024: null, price2025_old: null, price2025_new: 11800 },
            ]
        };

        const ARNONA_RATE = 3.58;
        let timelineChartInstance;
        let priceIncreaseChartInstance;

        // --- Data Consolidation ---
        const allAreas = [...new Set(Object.values(housingData).flat().map(item => item.area))];
        const allHouseTypesByArea = allAreas.reduce((acc, area) => {
            acc[area] = [...new Set(Object.values(housingData).flat().filter(h => h.area === area).map(h => h.type))];
            return acc;
        }, {});
        const allComparableHouses = allAreas.flatMap(area => 
            allHouseTypesByArea[area].map(type => ({area, type}))
        );

        // --- Chart Instances & Global Vars ---
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        const increaseCtx = document.getElementById('priceIncreaseChart').getContext('2d');

        // --- Timeline Chart Logic ---
        function updateTimelineChart(area, houseType) {
            if (timelineChartInstance) {
                timelineChartInstance.destroy();
            }
            if (!area || !houseType) return;

            const datasets = [];
            const ageGroupLabels = { '30_MINUS': '30 ומטה', '31-37': '31-37', '38_PLUS': '38 ומעלה' };
            const colors = ['rgba(54, 162, 235, 1)', 'rgba(255, 159, 64, 1)', 'rgba(75, 192, 192, 1)'];
            let colorIndex = 0;

            for (const group in housingData) {
                const house = housingData[group].find(h => h.area === area && h.type === houseType);
                if (house) {
                    const arnona = house.sqm && house.price2025_new ? house.sqm * ARNONA_RATE : 0;
                    const newPrice = house.price2025_new ? house.price2025_new + arnona : null;
                    datasets.push({
                        label: ageGroupLabels[group],
                        data: [house.price2022, house.price2023, house.price2024, house.price2025_old, newPrice],
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length].replace('1)', '0.2)'),
                        fill: false,
                        tension: 0.1,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        spanGaps: true
                    });
                    colorIndex++;
                }
            }

            timelineChartInstance = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: ['2022', '2023', '2024', '2025 (הסדר קיים)', '2025 (הסדר חדש)'],
                    datasets: datasets
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false, ticks: { callback: value => '₪' + value.toLocaleString() } } },
                    plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label}: ₪${context.parsed.y.toLocaleString()}` } } }
                }
            });
        }

        // --- Price Increase Analysis Logic ---
        function updateIncreaseChart(option, ageGroup) {
            if (priceIncreaseChartInstance) {
                priceIncreaseChartInstance.destroy();
            }

            const groupData = housingData[ageGroup];
            const increaseData = groupData.map(house => {
                let isComparable = true;
                if (option === '2022_2025_orig') {
                    isComparable = house.price2022 != null && house.price2025_old != null;
                } else if (option === '2024_2025_orig') {
                    isComparable = house.price2024 != null && house.price2025_old != null;
                } else if (option === '2024_2025_new') {
                    isComparable = house.price2024 != null && house.price2025_new != null;
                }

                if (!isComparable) {
                    return null;
                }

                let currentStart = null;
                let currentEnd = null;
                const arnona = house.sqm && house.price2025_new ? house.sqm * ARNONA_RATE : 0;

                if (option === '2022_2025_orig') {
                    currentStart = house.price2022;
                    currentEnd = house.price2025_old;
                } else if (option === '2024_2025_orig') {
                    currentStart = house.price2024;
                    currentEnd = house.price2025_old;
                } else if (option === '2024_2025_new') {
                    currentStart = house.price2024;
                    currentEnd = house.price2025_new + arnona;
                }

                if (currentStart === 0) return { type: house.type, increase: 0 };
                const increase = ((currentEnd - currentStart) / currentStart) * 100;

                return { type: house.type, increase };
            }).filter(d => d !== null).sort((a, b) => b.increase - a.increase);

            priceIncreaseChartInstance = new Chart(increaseCtx, {
                type: 'polarArea',
                data: {
                    labels: increaseData.map(d => d.type),
                    datasets: [{
                        label: 'אחוז עלייה',
                        data: increaseData.map(d => d.increase),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)','rgba(54, 162, 235, 0.7)','rgba(255, 206, 86, 0.7)','rgba(75, 192, 192, 0.7)','rgba(153, 102, 255, 0.7)','rgba(255, 159, 64, 0.7)','rgba(201, 203, 207, 0.7)','rgba(255, 99, 255, 0.7)','rgba(99, 255, 132, 0.7)','rgba(99, 132, 255, 0.7)','rgba(255, 255, 99, 0.7)','rgba(132, 99, 255, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { ticks: { backdropColor: 'transparent', callback: value => value.toFixed(0) + '%' }, grid: { color: 'rgba(0, 0, 0, 0.1)' } } },
                    plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: context => ` ${context.label}: ${context.raw.toFixed(2)}%` } } }
                }
            });
        }

        // --- Personal Calculator Logic ---
        const ageInput = document.getElementById('ageInput');
        const areaSelectCalc = document.getElementById('areaSelectCalc');
        const houseTypeSelectCalc = document.getElementById('houseTypeSelectCalc');
        const sqmInputCalc = document.getElementById('sqmInputCalc');
        const calculateBtn = document.getElementById('calculateBtn');
        const personalResultDiv = document.getElementById('personalResult');
        const summaryDiv = document.getElementById('summary');

        function populateCalcAreaSelect() {
            areaSelectCalc.innerHTML = '<option selected disabled>בחירה...</option>';
            allAreas.forEach(area => areaSelectCalc.add(new Option(area, area)));
        }

        areaSelectCalc.addEventListener('change', () => {
            const selectedArea = areaSelectCalc.value;
            houseTypeSelectCalc.innerHTML = '<option selected disabled>בחירה...</option>';
            allHouseTypesByArea[selectedArea].forEach(type => houseTypeSelectCalc.add(new Option(type, type)));
            houseTypeSelectCalc.disabled = false;
        });
        
        function checkCalcButtonState() {
            calculateBtn.disabled = !(ageInput.value && areaSelectCalc.value && houseTypeSelectCalc.value && sqmInputCalc.value);
        }

        [ageInput, areaSelectCalc, houseTypeSelectCalc, sqmInputCalc].forEach(el => el.addEventListener('change', checkCalcButtonState));
        [ageInput, sqmInputCalc].forEach(el => el.addEventListener('input', checkCalcButtonState));


        houseTypeSelectCalc.addEventListener('change', () => {
            const age = parseInt(ageInput.value);
            if (!age) return;
            const ageGroup = age <= 30 ? '30_MINUS' : (age <= 37 ? '31-37' : '38_PLUS');

            const selectedHouse = housingData[ageGroup].find(h => h.area === areaSelectCalc.value && h.type === houseTypeSelectCalc.value);
            sqmInputCalc.disabled = false;
            if (selectedHouse && selectedHouse.sqm) {
                sqmInputCalc.value = selectedHouse.sqm;
            } else {
                sqmInputCalc.value = '';
                sqmInputCalc.placeholder = 'שטח לא נמצא, בבקשה להזין ידנית';
            }
            checkCalcButtonState();
        });

        calculateBtn.addEventListener('click', () => {
            const age = parseInt(ageInput.value);
            const ageGroup = age <= 30 ? '30_MINUS' : (age <= 37 ? '31-37' : '38_PLUS');
            const selectedArea = areaSelectCalc.value;
            const selectedType = houseTypeSelectCalc.value;
            const sqm = parseFloat(sqmInputCalc.value);

            if (!age || !selectedArea || !selectedType || !sqm || sqm <= 0) {
                alert('יש למלא את כל השדות כראוי.');
                return;
            }

            const selectedHouse = housingData[ageGroup].find(h => h.area === selectedArea && h.type === selectedType);
            if (!selectedHouse) {
                alert('לא נמצאו נתונים עבור הבחירה שלך בקבוצת הגיל שלך.');
                return;
            }

            const price2025old = selectedHouse.price2025_old;
            const price2025new_base = selectedHouse.price2025_new;
            
            if (price2025old === null || price2025new_base === null) {
                 summaryDiv.innerHTML = `<p class="text-xl text-gray-600">לא ניתן לבצע השוואה עבור בית זה מכיוון שחסרים נתונים באחד ההסדרים.</p>`;
                 personalResultDiv.classList.remove('hidden');
                 document.getElementById('interactive-visualization').classList.add('hidden');
                 return;
            }
            
            document.getElementById('interactive-visualization').classList.remove('hidden');

            const arnona = sqm * ARNONA_RATE;
            const newTotalPrice = price2025new_base + arnona;
            const increasePercentage = price2025old > 0 ? ((newTotalPrice - price2025old) / price2025old) * 100 : 0;

            let discountHTML = '';
            if (ageGroup !== '38_PLUS') {
                const seniorHouse = housingData['38_PLUS'].find(h => h.area === selectedArea && h.type === selectedType);
                if (seniorHouse && seniorHouse.price2025_new && seniorHouse.sqm) {
                    const seniorNewPrice = seniorHouse.price2025_new + (seniorHouse.sqm * ARNONA_RATE);
                    if (seniorNewPrice > 0) {
                        const discount = ((seniorNewPrice - newTotalPrice) / seniorNewPrice) * 100;
                        if (discount > 0) {
                            discountHTML = `<div class="discount-badge">הנחה של ${discount.toFixed(2)}% לעומת תעריף 38+</div>`;
                        }
                    }
                }
            }

            summaryDiv.innerHTML = `
                <p class="text-xl text-gray-600">המחיר החל מספטמבר 25 לפי ההסדר הקיים: <span class="font-bold text-blue-600">₪${price2025old.toLocaleString()}</span></p>
                <p class="text-xl text-gray-600 mt-2">המחיר החל מספטמבר 25 לפי ההסדר המוצע:</p>
                <p class="summary-value summary-value-bad">₪${newTotalPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                <p class="text-sm text-gray-500">(₪${price2025new_base.toLocaleString()} שכירות + ₪${arnona.toFixed(2)} ארנונה)</p>
                <p class="text-2xl font-bold mt-4">התייקרות של <span class="text-red-500">${increasePercentage.toFixed(2)}%</span></p>
                ${discountHTML}
            `;
            personalResultDiv.classList.remove('hidden');

            // Animate bars
            const maxPrice = Math.max(price2025old, newTotalPrice) * 1.1;
            const oldPriceWidth = (price2025old / maxPrice) * 100;
            const newPriceWidth = (newTotalPrice / maxPrice) * 100;

            document.getElementById('old-price-bar').style.width = `${oldPriceWidth}%`;
            document.getElementById('old-price-label').innerText = `₪${price2025old.toLocaleString()}`;
            document.getElementById('new-price-bar').style.width = `${newPriceWidth}%`;
            document.getElementById('new-price-label').innerText = `₪${newTotalPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        });

        // --- Event Listeners & Initializers ---
        document.addEventListener('DOMContentLoaded', () => {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
            const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
            const desktopNavLinks = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            function switchTab(tabName) {
                // Hide all content
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                // Show target content
                document.getElementById(tabName).classList.remove('hidden');

                // Update desktop tabs active state
                desktopNavLinks.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });

                // Close mobile menu
                mobileMenuOverlay.classList.add('hidden');
            }

            mobileMenuBtn.addEventListener('click', () => {
                mobileMenuOverlay.classList.toggle('hidden');
            });

            mobileNavLinks.forEach(link => {
                link.addEventListener('click', () => {
                    switchTab(link.dataset.tab);
                });
            });
            
            desktopNavLinks.forEach(link => {
                link.addEventListener('click', () => {
                    switchTab(link.dataset.tab);
                });
            });
            
            // Timeline Tab Selects
            const areaSelectTimeline = document.getElementById('areaSelectTimeline');
            const houseTypeSelectTimeline = document.getElementById('houseTypeSelectTimeline');
            areaSelectTimeline.innerHTML = '<option selected disabled>בחירה...</option>';
            allAreas.forEach(area => areaSelectTimeline.add(new Option(area, area)));
            
            areaSelectTimeline.addEventListener('change', () => {
                const selectedArea = areaSelectTimeline.value;
                houseTypeSelectTimeline.innerHTML = '<option selected disabled>בחירה...</option>';
                allHouseTypesByArea[selectedArea].forEach(type => houseTypeSelectTimeline.add(new Option(type, type)));
                houseTypeSelectTimeline.disabled = false;
                updateTimelineChart(null, null);
            });
            houseTypeSelectTimeline.addEventListener('change', () => {
                updateTimelineChart(areaSelectTimeline.value, houseTypeSelectTimeline.value);
            });

            // Increase Analysis Tab Radios
            const increaseOptionRadios = document.querySelectorAll('input[name="increase_option"]');
            const ageGroupOptionRadios = document.querySelectorAll('input[name="age_group_option"]');

            function handleIncreaseChartUpdate() {
                const selectedOption = document.querySelector('input[name="increase_option"]:checked').value;
                const selectedAgeGroup = document.querySelector('input[name="age_group_option"]:checked').value;
                updateIncreaseChart(selectedOption, selectedAgeGroup);
            }

            increaseOptionRadios.forEach(radio => radio.addEventListener('change', handleIncreaseChartUpdate));
            ageGroupOptionRadios.forEach(radio => radio.addEventListener('change', handleIncreaseChartUpdate));
            
            // Initialize
            function initializeTimelineWithRandom() {
                const randomHouse = allComparableHouses[Math.floor(Math.random() * allComparableHouses.length)];
                areaSelectTimeline.value = randomHouse.area;
                
                const event = new Event('change');
                areaSelectTimeline.dispatchEvent(event);

                houseTypeSelectTimeline.value = randomHouse.type;
                updateTimelineChart(randomHouse.area, randomHouse.type);
            }

            populateCalcAreaSelect();
            handleIncreaseChartUpdate(); // Initial chart
            initializeTimelineWithRandom();
        });
    </script>

</body>
</html>
